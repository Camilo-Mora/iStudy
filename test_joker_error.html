<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Joker Error Replicator</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            background: #f4f7f6;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        pre {
            background: #eee;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }

        .error {
            color: #d9534f;
            font-weight: bold;
            background: #f2dede;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ebccd1;
        }

        .success {
            color: #5cb85c;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:disabled {
            background: #ccc;
        }
    </style>
</head>

<body>
    <h1>Joker Error Replicator</h1>
    <p>This page tests if a <strong>Safety Refusal</strong> triggers the "Cannot read properties of undefined (reading
        '0')" error.</p>

    <div class="card">
        <h3>Step 1: Check API Key</h3>
        <input type="password" id="apiKey" placeholder="Paste your Google API Key here"
            style="width: 100%; padding: 10px; margin-bottom: 10px;">
        <p><small>Note: This page uses the same fallback logic as your app.</small></p>
    </div>

    <div class="card">
        <h3>Step 2: Replicate Student Context</h3>
        <p><strong>Topic:</strong> Evolution, Energy, and Stability</p>
        <p><strong>Mode:</strong> <span style="color:red">DECEPTIVE</span> (Triggering the "lie" about a fact)</p>
        <button id="testBtn">Trigger Joker Call</button>
    </div>

    <div id="outputContainer" style="display:none;">
        <div class="card">
            <h3>API Status</h3>
            <div id="status">Waiting...</div>
        </div>

        <div class="card">
            <h3>Raw API Response</h3>
            <pre id="rawResponse">{}</pre>
        </div>

        <div class="card">
            <h3>Resulting Error (Crash Test)</h3>
            <div id="crashResult"></div>
        </div>
    </div>

    <script>
        // --- COPIED DIRECTLY FROM index.html ---

        const GeminiRequest = async (model, promptText) => {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) throw new Error("No API Key provided in the input above.");

            // Basic simulation of your app's chain
            const currentModel = model || 'gemini-2.5-flash';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;

            console.log(`Attempting Call [Model: ${currentModel}]...`);

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
            });

            return await response.json();
        };

        const invokeLLM = async (prompt, context = {}) => {
            const systemContext = `
                You are playing a role in an educational system for a Biogeography course.
                Your task is to respond as an AI character to a student's response.
                
                Course Data:
                - Lecture Transcript: ${context.transcript || 'Not available'}
                - The Question: ${context.question || 'Not available'}
                - Student's Transcribed Response: ${context.student_response || 'Not available'}

                Character/Instruction: ${prompt}
                
                Please keep your response academic yet engaging, and stay strictly within the context of the course transcript provided.
            `;

            try {
                const data = await GeminiRequest('gemini-2.5-flash', systemContext);

                // DISPLAY RAW RESPONSE FOR DEBUGGING
                document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);

                // --- NEW SAFETY GUARDRAIL ---
                // We check if 'candidates' exists BEFORE trying to read index 0.
                if (!data.candidates || data.candidates.length === 0) {
                    throw new Error("SAFETY_BLOCK: The AI's safety filter blocked this response. This usually happens when the model is asked to generate a 'Challenge' (falsehood) on a sensitive topic like evolution.");
                }

                // Now it is safe to read [0]
                return data.candidates[0].content.parts[0].text;

            } catch (err) {
                console.error("Caught Error:", err);
                throw err;
            }
        };

        // --- TEST RUNNER ---

        document.getElementById('testBtn').addEventListener('click', async () => {
            const output = document.getElementById('outputContainer');
            const status = document.getElementById('status');
            const crash = document.getElementById('crashResult');
            const btn = document.getElementById('testBtn');

            output.style.display = 'block';
            status.innerHTML = "Processing...";
            crash.innerHTML = "";
            btn.disabled = true;

            const mockContext = {
                question: "Explain the relationship between constant energy, stability, and evolution.",
                transcript: "Life requires a steady supply of energy and environmental stability to allow the slow process of evolution and diversification to occur over millions of years.",
                student_response: "constant energy and stability is like exercise in a way, if you run you need energy or you gas out."
            };

            const jokerChallengePrompt = `### EDUCATIONAL CONTEXT
This is a controlled Socratic exercise for a Biogeography course. You are training the student's critical thinking skills. You play "Joker," a confident peer who helps the student distinguish between the "Scientific Ground Truth" and a "Conceptual Oversight."

### INPUT DATA
1. **The Question:** ${mockContext.question}
2. **The Scientific Ground Truth (Verified Fact):** ${mockContext.transcript}
3. **The Target Orientation:** CHALLENGE (You must present a flawed version of the truth)

### INSTRUCTIONS
Your goal is to test if the student can identify when a peer (you) is confidently stating something incorrect versus something accurate.

**If your Orientation is "FACTUAL":**
* Paraphrase the **Scientific Ground Truth** using different words while keeping 100% of the accuracy.

**If your Orientation is "CHALLENGE":**
* You must present a **Flawed Version** of the Scientific Ground Truth.
* This version must sound plausible to a casual student but be **factually or logically incorrect**.
* **Use one of these Transformation Tactics:**
    1.  **The Reversal:** Swap the Cause and Effect from the Ground Truth (e.g., if A causes B, state that B causes A).
    2.  **The Absolute:** Remove a necessary nuance or constraint. State a conditional truth as if it were always true without exception.
    3.  **The Logic Trap:** State a common misconception that sounds "common sense" but contradicts the Ground Truth.

### MANDATORY GUARDRAILS
1. **Confidence:** Regardless of your orientation, speak with absolute confidence.
2. **No Hair-Splitting:** The error in a CHALLENGE statement must be objective and indisputable. 
3. **Professor Check:** Before responding, ensure that a professor would mark your CHALLENGE statement as "WRONG."
4. **Tone:** Speak as a peer. Start with phrases like "I remember the video mentioned that..." and end with "Do you agree?" or "Does that sound right?".

### OUTPUT FORMAT
Output *only* the dialogue. No labels. No preamble. No "Version 1 vs Version 2". Just your speech.`;

            try {
                const result = await invokeLLM(jokerDeceptivePrompt, mockContext);
                status.innerHTML = "<span class='success'>Success! (No block occurred)</span>";
                crash.innerHTML = "Result: " + result;
            } catch (err) {
                status.innerHTML = "<span class='error'>Error Detected</span>";

                if (err.message.includes("'0'") || err.message.includes("undefined")) {
                    crash.innerHTML = `<div class='error'>
                        REPLICATED!<br>
                        Error: ${err.message}<br>
                        Reason: The API response was blocked by Safety Filters, causing 'candidates' to be undefined.
                    </div>`;
                } else {
                    crash.innerHTML = `<div class='error'>Other Error: ${err.message}</div>`;
                }
            } finally {
                btn.disabled = false;
            }
        });

        // Load key from localStorage if it exists (like your app)
        const saved = localStorage.getItem('google_api_key');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                document.getElementById('apiKey').value = Array.isArray(parsed) ? parsed[0].key : saved;
            } catch (e) {
                document.getElementById('apiKey').value = saved;
            }
        }
    </script>
</body>

</html>