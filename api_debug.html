<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API Model Tester</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: #f8fafc;
            color: #334155;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            margin-top: 0;
            color: #0f172a;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        select,
        input,
        textarea,
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        button:hover {
            background: #2563eb;
        }

        pre {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 13px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .log-error {
            color: #ef4444;
        }

        .log-success {
            color: #166534;
        }

        .log-info {
            color: #3b82f6;
        }
    </style>
</head>

<body>

    <h1>ðŸ¤– Gemini Model Debugger</h1>

    <div class="card">
        <label>Selected Model (Preference stored in localStorage)</label>
        <select id="modelSelector">
            <option value="gemini-3-flash">gemini-3-flash (Recommended)</option>
            <option value="gemini-2.5-flash">gemini-2.5-flash (Standard)</option>
            <option value="gemini-3-flash-preview">gemini-3-flash-preview (Backup)</option>
            <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp (Experimental)</option>
        </select>

        <label>Manual API Key (Optional, if none found in storage)</label>
        <input type="password" id="manualKeyInput" placeholder="Paste API Key here to force test...">

        <label>Test Prompt</label>
        <textarea id="promptInput" rows="3">Hello, can you hear me?</textarea>

        <div style="display:flex; gap:10px;">
            <button onclick="runTest()">ðŸš€ Test API Call</button>
            <button onclick="listAvailableModels()" style="background:#64748b;">ðŸ“‹ List Available Models</button>
        </div>
    </div>

    <div class="card">
        <h3>Execution Log</h3>
        <div id="logs"></div>
    </div>

    <div class="card">
        <h3>Final Result</h3>
        <pre id="resultOutput">No result yet.</pre>
    </div>

    <script>
        // --- LOGGING HELPER ---
        function log(msg, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedModel = localStorage.getItem('iStudy_preferred_model') || 'gemini-3-flash';
            document.getElementById('modelSelector').value = savedModel;
            log(`Loaded saved model preference: ${savedModel}`);

            const rawKeys = localStorage.getItem('gemini-api-keys');
            if (rawKeys) {
                log(`Found API keys in storage (Length: ${rawKeys.length} chars)`, 'success');
            } else {
                log('WARNING: No API keys found in localStorage. Please add them in the main app first.', 'error');
            }
        });

        // --- CORE FUNCTION (THE ONE TO TEST) ---
        window.Core = {
            GeminiRequest: async (model, promptText) => {
                let keys = [];

                // 1. Try LocalStorage
                try {
                    const raw = localStorage.getItem('gemini-api-keys');
                    if (raw) {
                        try {
                            const parsed = JSON.parse(raw);
                            if (Array.isArray(parsed)) {
                                keys = parsed;
                            } else {
                                keys = [{ key: raw, label: 'Storage Key' }];
                            }
                        } catch (jsonErr) {
                            // Maybe it's just a raw string
                            if (raw.length > 10) keys = [{ key: raw, label: 'Storage Key' }];
                        }
                    }
                } catch (e) {
                    console.error("Storage Access Error:", e);
                }

                // 2. Filter out bad storage keys immediately
                keys = keys.filter(k => k && k.key && k.key.trim().length > 10);

                // 3. Check Manual Input (Highest Priority)
                const manualKeyInput = document.getElementById('manualKeyInput');
                if (manualKeyInput && manualKeyInput.value) {
                    const val = manualKeyInput.value.trim();
                    if (val.length > 10) {
                        // Add to front of list
                        keys.unshift({ key: val, label: 'Manual Input' });
                    }
                }

                if (keys.length === 0) throw new Error("No valid API Keys available using.");

                // UPDATED: Use gemini-3-flash by default
                let targetModel = model || 'gemini-3-flash';
                log(`Starting Request. Preferred: ${targetModel}`, 'info');

                // DEBUG STRICT MODE: Only test the selected model.
                // WE DO NOT FALLBACK HERE, so the user can verify exactly which model is failing.
                const modelChain = [targetModel];

                const uniqueChain = [...new Set(modelChain)];

                let lastError = null;
                const errorLog = [];

                for (const currentModel of uniqueChain) {
                    log(`Attempting Model: ${currentModel}`, 'info');

                    for (let i = 0; i < keys.length; i++) {
                        const kObj = keys[i];
                        const apiKey = kObj.key.trim();
                        // MASKED KEY FOR LOGGING
                        const maskedKey = apiKey.substring(0, 4) + '...' + apiKey.substring(apiKey.length - 4);

                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;

                        try {
                            log(`Try Key [${kObj.label || 'Default'}] (${maskedKey})...`);

                            const response = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                            });

                            const data = await response.json();

                            if (data.error) {
                                const msg = data.error.message || JSON.stringify(data.error);
                                const errStr = `[${currentModel}]: ${msg}`;
                                log(`API Error: ${msg}`, 'error');
                                errorLog.push(errStr);

                                // On debug page, we continue to next KEY, but we do not switch models anymore (unless we had multiple models in chain, which we don't).
                                continue;
                            }

                            log(`Success! Response received using ${currentModel}`, 'success');
                            return data;

                        } catch (err) {
                            const msg = err.message || "";
                            const errStr = `[${currentModel} Net]: ${msg}`;
                            log(`Network/Fetch Error: ${msg}`, 'error');
                            errorLog.push(errStr);
                            continue;
                        }
                    }
                }

                const finalMsg = "All attempts failed. Details:\n" + errorLog.join("\n");
                throw new Error(finalMsg);
            }
        };

        // --- MODEL LISTER ---
        async function listAvailableModels() {
            const output = document.getElementById('resultOutput');
            const logs = document.getElementById('logs');
            output.textContent = "Fetching model list...";
            logs.innerHTML = "";

            // Get key
            let apiKey = document.getElementById('manualKeyInput').value.trim();
            if (!apiKey) {
                const raw = localStorage.getItem('gemini-api-keys');
                if (raw) {
                    try {
                        const parsed = JSON.parse(raw);
                        if (Array.isArray(parsed) && parsed.length > 0) apiKey = parsed[0].key;
                        else apiKey = raw;
                    } catch (e) { apiKey = raw; }
                }
            }

            if (!apiKey || apiKey.length < 10) {
                log("Error: Please enter a Manual API Key first.", "error");
                output.textContent = "Error: No API Key found.";
                return;
            }

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
                log(`Fetching models from: ${url}`, 'info');
                const res = await fetch(url);
                const data = await res.json();

                if (data.models) {
                    output.textContent = JSON.stringify(data.models, null, 2);
                    log(`Success! Found ${data.models.length} models.`, 'success');
                } else {
                    output.textContent = JSON.stringify(data, null, 2);
                    log("API returned response but no 'models' array.", 'info');
                }
            } catch (e) {
                output.textContent = "Error: " + e.message;
                log(e.message, 'error');
            }
        }

        // --- TEST RUNNER ---
        async function runTest() {
            const model = document.getElementById('modelSelector').value;
            const prompt = document.getElementById('promptInput').value;
            const output = document.getElementById('resultOutput');
            const logs = document.getElementById('logs');

            // Save preference
            localStorage.setItem('iStudy_preferred_model', model);

            output.textContent = "Running...";
            logs.innerHTML = ""; // Clear logs
            log("Use 'View Page Source' to see the full code.", 'info');

            try {
                const data = await window.Core.GeminiRequest(model, prompt);
                output.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                output.textContent = "FATAL ERROR:\n" + err.message;
                log(`Test Failed: ${err.message}`, 'error');
            }
        }
    </script>
</body>

</html>